<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>கன்ய சம்பூர்ணா திட்டம் - 10ம் வகுப்பு கணிதம்</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4a148c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="application-name" content="Kanya Maths">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@400;600;800&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4a148c; /* Deep Purple */
            --primary-gradient: linear-gradient(135deg, #4a148c 0%, #7c43bd 100%);
            --secondary-color: #ffca28; /* Amber Accent */
            --text-dark: #1a1a1a;
            --text-gray: #555555;
            --text-light: #ffffff;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --shadow-md: 0 8px 24px rgba(0,0,0,0.12);
            --radius-lg: 20px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Poppins', 'Noto Sans Tamil', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-dark);
            line-height: 1.5;
            overflow-x: hidden;
            min-height: 100vh;
        }

        header {
            background: var(--primary-gradient);
            color: var(--text-light);
            padding: 20px 10px 50px 10px;
            text-align: center;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
            box-shadow: var(--shadow-md);
            position: relative;
            z-index: 10;
        }

        .header-content { max-width: 100%; margin: 0 auto; overflow: hidden; }
        .header-main { font-size: clamp(1rem, 4.5vw, 1.8rem); font-weight: 800; margin-bottom: 8px; line-height: 1.3; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .header-sub { font-size: clamp(0.7rem, 2.5vw, 1rem); font-weight: 800; margin-bottom: 12px; color: rgba(255, 255, 255, 0.95); }
        .header-badge { display: inline-flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.15); backdrop-filter: blur(5px); padding: 8px 15px; border-radius: var(--radius-lg); border: 1px solid rgba(255,255,255,0.3); margin-top: 10px; white-space: nowrap; }
        .header-class { font-size: clamp(0.9rem, 3.5vw, 1.2rem); font-weight: 800; color: var(--secondary-color); }
        .header-subject { font-size: clamp(1rem, 4vw, 1.4rem); font-weight: 800; text-transform: uppercase; color: #fff; }

        .stats-dashboard {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: -35px auto 30px;
            padding: 0 15px;
            position: relative;
            z-index: 20;
            max-width: 600px;
        }

        .stat-card {
            background: white;
            padding: 12px 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value { font-size: 1.3rem; font-weight: 800; color: var(--primary-color); }
        .stat-label { font-size: 0.75rem; color: var(--text-gray); font-weight: 600; margin-top: 5px; }

        .chapter-container { max-width: 800px; margin: 20px auto; padding: 0 15px 50px; }
        .chapter-item { background: white; border-radius: 12px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .chapter-header { padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: white; user-select: none; }
        .chapter-header.active { border-bottom: 1px solid #eee; background: #fdfbff; }
        .chapter-title { font-size: 1rem; font-weight: 700; color: var(--primary-color); display: flex; align-items: center; gap: 10px; }
        .arrow-icon { transition: transform 0.3s; color: #ccc; }
        .chapter-header.active .arrow-icon { transform: rotate(180deg); color: var(--primary-color); }

        .video-list { display: none; padding: 10px; background: #fafafa; }
        .chapter-header.active + .video-list { display: block; animation: fadeIn 0.3s ease; }

        .video-card { display: flex; align-items: center; background: white; padding: 12px; margin-bottom: 8px; border-radius: 10px; cursor: pointer; border: 1px solid #efefef; transition: all 0.2s; }
        .video-card:active { transform: scale(0.97); background: #f0f0f0; }

        .video-thumb-mini { width: 80px; height: 50px; border-radius: 6px; background-size: cover; background-position: center; margin-right: 15px; flex-shrink: 0; background-color: #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .video-info { flex-grow: 1; }
        .video-name { font-size: 0.9rem; font-weight: 700; color: #333; margin-bottom: 2px; }
        .video-meta { font-size: 0.75rem; color: #888; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; justify-content: center; align-items: center; padding: 15px; }
        .modal.active { display: flex; }

        .video-container { width: 100%; max-width: 900px; aspect-ratio: 16/9; background: black; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5); position: relative; }
        .loading-spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: 600; }

        .stop-btn { margin-top: 25px; background: #ff5252; color: white; border: none; padding: 12px 40px; border-radius: 30px; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 10px rgba(255, 82, 82, 0.3); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <div class="header-main">கன்ய சம்பூர்ணா திட்டம் / கன்யா பெண்கள் கல்வி திட்டம்</div>
            <div class="header-sub">இத்திட்டம் TITAN மற்றும் KALIKE நிறுவனங்களின் பங்களிப்புடன் செயல்படுத்தப்படுகிறது</div>
            <div class="header-badge">
                <div class="header-class">பத்தாம் வகுப்பு</div>
                <div class="header-separator">•</div>
                <div class="header-subject">கணிதம்</div>
            </div>
        </div>
    </header>

    <div class="stats-dashboard">
        <div class="stat-card">
            <div class="stat-value" id="visitorCount">...</div>
            <div class="stat-label">மாணவர்கள் (Students)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="hoursSpent">...</div>
            <div class="stat-label">மொத்த மணிநேரம் (Hours)</div>
        </div>
    </div>

    <div class="chapter-container" id="chapterList"></div>

    <div class="modal" id="videoModal">
        <div class="video-container" id="videoWrapper">
            <div class="loading-spinner">ஏற்றுகிறது...</div>
        </div>
        <button class="stop-btn" onclick="closeModal()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12"/></svg>
            நிறுத்து (Stop)
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Chapters List
        const chapters = [
            { id: 1, name: "இயல் 1. உறவுகளும் சார்புகளும்" },
            { id: 2, name: "இயல் 2. எண்களும் தொடர்வரிசைகளும்" },
            { id: 3, name: "இயல் 3: இயற்கணிதம்" },
            { id: 4, name: "இயல் 4: வடிவியல்" },
            { id: 5, name: "இயல் 5. ஆயத்தொலை வடிவியல்" },
            { id: 8, name: "இயல் 8: புள்ளியியலும் நிகழ்தகவும்" }
        ];

        // Highlight Style Configuration
        const textHighlightStyle = "color: #e91e63; font-weight: 800;";
        const creatorText = `<br><br><span style="${textHighlightStyle}">உருவாக்கியவர்: ப. கோமதி B.Sc.,B. Ed.,(கணிதவியல்)</span>`;

        // Video Data Store
        const videos = [
            { id: 1, chapter: 1, title: "உறவுகளும் சார்புகளும்", desc: `<span style="${textHighlightStyle}">எடுத்துக்காட்டு 1.11</span>${creatorText}`, type: "google", src: "13BumpuyMTovO7o-3xbpIzXfTXSZzC3kS" },
            // Chapter 2
            { id: 2, chapter: 2, title: "எண்களும் தொடர்வரிசைகளும் - பகுதி 1", desc: `<span style="${textHighlightStyle}">பயிற்சி 2.9</span>${creatorText}`, type: "google", src: "1Pr7e3fR-upUz_4n_JUYaOE6cUbkXG8Rl" },
            { id: 3, chapter: 2, title: "எண்களும் தொடர்வரிசைகளும் - பகுதி 2", desc: `<span style="${textHighlightStyle}">பயிற்சி 2.9</span>${creatorText}`, type: "google", src: "1rPMrQiy1SgjfjzbHTxdfP6JGjr0B_yjp" },
            // Chapter 3
            { id: 4, chapter: 3, title: "இயற்கணிதம் - பகுதி 1", desc: `<span style="${textHighlightStyle}">பயிற்சி 3.19 கணக்கு 8</span>${creatorText}`, type: "google", src: "1gzuFgiMrMFArxURLFhdSaEuHbFkoczS3" },
            { id: 5, chapter: 3, title: "இயற்கணிதம் - பகுதி 2", desc: `<span style="${textHighlightStyle}">பயிற்சி 3.19 கணக்கு 12</span>${creatorText}`, type: "google", src: "1G_qrhy3PtieOb6ZSpKx7dew_d596WX2a" },
            { id: 6, chapter: 3, title: "இயற்கணிதம் - பகுதி 3", desc: `<span style="${textHighlightStyle}">பயிற்சி 3.19 கணக்கு 13</span>${creatorText}`, type: "google", src: "1GQSEhIgpHtsQIqbgSOviFAVHK2RWbUsj" },
            // Chapter 4
            { id: 7, chapter: 4, title: "வடிவியல் - பகுதி 1", desc: `<span style="${textHighlightStyle}">தேல்ஸ் தேற்றம்</span>${creatorText}`, type: "google", src: "12h5X529Or5vMmhs18BZaC7oFpZ8F3ADv" },
            { id: 8, chapter: 4, title: "வடிவியல் - பகுதி 2", desc: `<span style="${textHighlightStyle}">பிதாகரஸ் தேற்றம்</span>${creatorText}`, type: "google", src: "1aPgFL7DmihdusQJdbcYu7kkc0oUiWrWw" },
            // Chapter 5
            { id: 9, chapter: 5, title: "ஆயத்தொலை வடிவியல் - பகுதி 1", desc: `<span style="${textHighlightStyle}">பயிற்சி 5.1 கணக்கு எண் 1(i ,ii )</span>${creatorText}`, type: "google", src: "1MN1uCR-vWE2PdRpMvqRxIqWdzOJTHHlY" },
            { id: 10, chapter: 5, title: "ஆயத்தொலை வடிவியல் - பகுதி 2", desc: `<span style="${textHighlightStyle}">எடுத்துக்காட்டு 5.5</span>${creatorText}`, type: "google", src: "1JNJujXrRDVe_yV7bZkKlR5B7RZZTDErn" },
            // Chapter 8
            { id: 11, chapter: 8, title: "புள்ளியியலும் நிகழ்தகவும்", desc: `<span style="${textHighlightStyle}">பயிற்சி 8.x</span>${creatorText}`, type: "google", src: "1FMWXPBTVVs3vB5eea-NkTHLRRtsjXQIn" }
        ];

        let activeChapterId = 1;

        // UI Handlers
        window.toggleChapter = (id) => {
            activeChapterId = (activeChapterId === id) ? null : id;
            renderApp();
        };

        window.playVideo = (id) => {
            const v = videos.find(item => item.id === id);
            const modal = document.getElementById('videoModal');
            const wrapper = document.getElementById('videoWrapper');
            modal.classList.add('active');
            wrapper.innerHTML = '<div class="loading-spinner">ஏற்றுகிறது...</div>';
            
            let url = v.type === 'youtube' 
                ? `https://www.youtube.com/embed/${v.src}?autoplay=1&mute=0&playsinline=1` 
                : `https://drive.google.com/file/d/${v.src}/preview?autoplay=1`;

            // Timeout to allow DOM transition before injecting iframe
            setTimeout(() => {
                const iframe = document.createElement('iframe');
                iframe.style.width = "100%"; iframe.style.height = "100%"; iframe.style.border = "none";
                iframe.setAttribute('allow', 'autoplay; fullscreen; encrypted-media; picture-in-picture');
                iframe.src = url;
                
                // Clear and Append
                wrapper.innerHTML = '';
                wrapper.appendChild(iframe);
            }, 300);
        };

        window.closeModal = () => {
            document.getElementById('videoModal').classList.remove('active');
            document.getElementById('videoWrapper').innerHTML = '';
        };

        function getThumb(v) {
            return v.type === 'youtube' 
                ? `https://img.youtube.com/vi/${v.src}/hqdefault.jpg`
                : `https://drive.google.com/thumbnail?id=${v.src}&sz=w300`;
        }

        function renderApp() {
            const list = document.getElementById('chapterList');
            if(!list) return;
            list.innerHTML = chapters.map(ch => {
                const chapterVideos = videos.filter(v => v.chapter === ch.id);
                const isActive = ch.id === activeChapterId;
                return `
                    <div class="chapter-item">
                        <div class="chapter-header ${isActive ? 'active' : ''}" onclick="window.toggleChapter(${ch.id})">
                            <div class="chapter-title">${ch.name}</div>
                            <div class="arrow-icon">▼</div>
                        </div>
                        <div class="video-list">
                            ${chapterVideos.length > 0 ? chapterVideos.map(v => `
                                <div class="video-card" onclick="window.playVideo(${v.id})">
                                    <div class="video-thumb-mini" style="background-image: url('${getThumb(v)}')"></div>
                                    <div class="video-info">
                                        <div class="video-name">${v.title}</div>
                                        <div class="video-meta">${v.desc}</div>
                                    </div>
                                    ▶
                                </div>
                            `).join('') : '<div style="padding:15px; font-size:0.85rem; color:#888; text-align:center;">இந்த இயலுக்கான காணொளிகள் விரைவில் வரும்...</div>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Firebase Stats Core Logic
        async function initStats() {
            try {
                if (typeof __firebase_config === 'undefined' || !__firebase_config) return;
                const config = JSON.parse(__firebase_config);
                const app = initializeApp(config);
                const auth = getAuth(app);
                const db = getFirestore(app);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'kanya-math-global';

                // Initial Auth - Essential for Firestore Permissions
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for Auth Completion before doing DB Ops
                onAuthStateChanged(auth, async (user) => {
                    if (!user) return;
                    
                    const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'global_stats');

                    // Global Stats Observer
                    onSnapshot(statsRef, (snap) => {
                        if(snap.exists()) {
                            const data = snap.data();
                            document.getElementById('visitorCount').innerText = (data.visitor_count || 0).toLocaleString();
                            const hours = (data.total_minutes || 0) / 60;
                            document.getElementById('hoursSpent').innerText = hours.toFixed(1);
                        } else {
                            document.getElementById('visitorCount').innerText = "0";
                            document.getElementById('hoursSpent').innerText = "0.0";
                        }
                    }, (err) => console.log("Stats Fail (Observer):", err));

                    // Unique Visitor Tracking per Browser
                    if(!localStorage.getItem('kanya_global_visitor_v3')) {
                        localStorage.setItem('kanya_global_visitor_v3', 'active');
                        await setDoc(statsRef, { visitor_count: increment(1) }, { merge: true });
                    }

                    // Global usage heart-beat (increment total minutes)
                    setInterval(async () => {
                        if(document.visibilityState === 'visible' && auth.currentUser) {
                            try {
                                await updateDoc(statsRef, { total_minutes: increment(1) });
                            } catch(e) {
                                await setDoc(statsRef, { total_minutes: increment(1) }, { merge: true });
                            }
                        }
                    }, 60000);
                });

            } catch(e) { console.error("Firebase Init Error:", e); }
        }

        // Initialize UI and Backend
        renderApp();
        initStats();
    </script>
</body>
</html>
